import{L as b,Zb as p,a,b as l,i as n,j as c}from"./chunk-QCVMPDFW.js";var u=class o{pb;COLLECTION="inspections";isSubscribed=!1;inspectionsSubject=new c([]);inspections$=this.inspectionsSubject.asObservable();eventsSubject=new n;events$=this.eventsSubject.asObservable();errorSubject=new n;errors$=this.errorSubject.asObservable();loadingSubject=new c(!1);get isLoading$(){return this.loadingSubject.asObservable()}async deleteInspection(t){try{return await this.pb.collection(this.COLLECTION).delete(t),!0}catch(e){throw console.error("Error al eliminar la inspecci\xF3n:",e),e}}constructor(){this.pb=new p("https://db.buckapi.site:8095"),this.pb.authStore.onChange((t,e)=>{!t&&this.isSubscribed&&(console.warn("[RealtimeInspectionsService] Sesi\xF3n expirada, suscripciones pausadas"),this.unsubscribeAll())}),this.subscribe()}async subscribe(t=!0){if(this.isSubscribed){console.log("[RealtimeInspectionsService] Ya est\xE1 suscrito");return}try{this.pb.authStore.isValid||console.warn("[RealtimeInspectionsService] No hay sesi\xF3n activa. Con\xE9ctate primero."),this.pb.collection(this.COLLECTION).subscribe("*",e=>{if(["create","update","delete"].includes(e.action)){let i=l(a({},e),{action:e.action});console.log("[Realtime] Evento recibido:",i.action,i.record.id),this.eventsSubject.next(i),this.handleRealtimeEvent(i)}}),this.isSubscribed=!0,console.log("[RealtimeInspectionsService] \u2713 Suscripci\xF3n activa"),t&&await this.loadInspections()}catch(e){throw this.handleError(e),e}}handleRealtimeEvent(t){let e=this.inspectionsSubject.value;switch(t.action){case"create":this.inspectionsSubject.next([t.record,...e]);break;case"update":let i=e.map(s=>s.id===t.record.id?t.record:s);this.inspectionsSubject.next(i);break;case"delete":this.inspectionsSubject.next(e.filter(s=>s.id!==t.record.id));break}}async loadInspections(t="-created"){try{let e=await this.pb.collection(this.COLLECTION).getFullList(200,{sort:t});console.log(`[RealtimeInspectionsService] Cargadas ${e.length} inspecciones`),this.inspectionsSubject.next(e)}catch(e){throw this.handleError(e),e}}async getInspectionsPaginated(t=1,e=50,i="-created",s){try{let r=await this.pb.collection(this.COLLECTION).getList(t,e,{sort:i,filter:s});return{items:r.items,totalItems:r.totalItems,totalPages:r.totalPages}}catch(r){throw this.handleError(r),r}}async getInspectionById(t){try{return await this.pb.collection(this.COLLECTION).getOne(t)}catch(e){throw this.handleError(e),e}}unsubscribeAll(){try{this.pb.collection(this.COLLECTION).unsubscribe(),this.isSubscribed=!1,console.log("[RealtimeInspectionsService] \u2717 Suscripciones eliminadas")}catch(t){this.handleError(t)}}isCurrentlySubscribed(){return this.isSubscribed}async authenticate(t,e){try{await this.pb.collection("users").authWithPassword(t,e),console.log("[RealtimeInspectionsService] \u2713 Autenticaci\xF3n exitosa")}catch(i){throw this.handleError(i),i}}logout(){this.unsubscribeAll(),this.pb.authStore.clear(),this.inspectionsSubject.next([]),console.log("[RealtimeInspectionsService] \u2713 Sesi\xF3n cerrada")}isAuthenticated(){return this.pb.authStore.isValid}getCurrentUser(){return this.pb.authStore.model}handleError(t){let e=t instanceof Error?t:new Error(String(t));console.error("[RealtimeInspectionsService] Error:",e),this.errorSubject.next(e)}ngOnDestroy(){this.unsubscribeAll(),this.inspectionsSubject.complete(),this.eventsSubject.complete(),this.errorSubject.complete()}static \u0275fac=function(e){return new(e||o)};static \u0275prov=b({token:o,factory:o.\u0275fac,providedIn:"root"})};export{u as a};

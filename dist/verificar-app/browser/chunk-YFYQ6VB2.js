import{M as u,l as i,mc as g,n as l,q as o,w as p,z as a}from"./chunk-Z3T7KZMH.js";var m=class c{pb;COLLECTION="inspections";constructor(){this.pb=new g("https://db.buckapi.site:8095")}async uploadImage(e,t){try{let r={image:e};console.log("\u{1F4E4} Subiendo imagen:",e.name),console.log("\u{1F4E6} Datos:",r);let n=await this.pb.collection("images").create(r);return console.log("\u2705 Imagen subida con ID:",n.id),n.id}catch(r){throw console.error("\u274C Error al subir imagen:",r),console.error("Response:",r.response),console.error("Data:",r.data),new Error(r.message||"Error al subir la imagen")}}async uploadMultipleImages(e,t){let r=[];for(let n of e)try{let s=await this.uploadImage(n,t);r.push(s)}catch(s){console.warn(`Fall\xF3 al subir ${n.name}:`,s)}return r}createInspection(e){return i(this.pb.collection(this.COLLECTION).create(e)).pipe(o(t=>t),a(this.handleError))}getAllInspections(e=1,t=50,r="-created",n){return i(this.pb.collection(this.COLLECTION).getList(e,t,{sort:r,filter:n,$autoCancel:!1})).pipe(o(s=>({items:s.items,totalItems:s.totalItems,totalPages:s.totalPages,page:s.page})),a(this.handleError))}getInspectionById(e){return i(this.pb.collection(this.COLLECTION).getOne(e)).pipe(o(t=>t),a(this.handleError))}searchByPlaca(e){return this.getAllInspections(1,50,"-created",`placa~"${e}"`).pipe(o(t=>t.items))}getImageUrl(e,t,r,n="0x0"){return`${this.pb.baseUrl}/api/files/${e}/${t}/${r}?thumb=${n}`}async getNextCertificateNumberPreview(e){let r=(await this.pb.collection("secuencias").getFirstListItem(`prefijo="${e}"`)).ultimo_numero+1;return`${e} ${String(r).padStart(4,"0")}`}async getNextCertificateNumber(e){let t=await this.pb.collection("secuencias").getFirstListItem(`prefijo="${e}"`),r=t.ultimo_numero+1;return await this.pb.collection("secuencias").update(t.id,{ultimo_numero:r}),`${e} ${String(r).padStart(4,"0")}`}getInspectionWithImages(e){return i(this.pb.collection(this.COLLECTION).getOne(e,{expand:"images"})).pipe(o(t=>t),a(this.handleError))}async getImageUrls(e){if(!e||e.length===0)return[];let t=[],r="5bjt6wpqfj0rnsl";for(let n of e)try{let d=(await this.pb.collection("images").getOne(n)).image,b=this.getImageUrl(r,n,d);t.push(b)}catch(s){console.error(`Error al obtener imagen ${n}:`,s)}return t}getInspectionsByEstado(e){return this.getAllInspections(1,100,"-created",`estado="${e}"`).pipe(o(t=>t.items))}updateInspection(e,t){return i(this.pb.collection(this.COLLECTION).update(e,t)).pipe(o(r=>r),a(this.handleError))}updateEstado(e,t){return this.updateInspection(e,{estado:t})}deleteInspection(e){return i(this.pb.collection(this.COLLECTION).delete(e)).pipe(a(this.handleError))}deleteMultipleInspections(e){let t=e.map(r=>this.deleteInspection(r));return p(t)}handleError(e){let t="Error desconocido";if(e instanceof Error)t=e.message;else if(e?.response){let r=e.status||e.response?.code||500;switch(r){case 400:t="Datos inv\xE1lidos o incompletos";break;case 401:t="No autorizado. Por favor inicie sesi\xF3n";break;case 403:t="Acceso denegado";break;case 404:t="Recurso no encontrado";break;case 409:t="Conflicto: El registro ya existe";break;case 500:t="Error interno del servidor";break;default:t=`Error ${r}: ${e.message||"Error desconocido"}`}}return console.error("Error en InspectionService:",t,e),l(()=>new Error(t))}validateInspectionData(e){let t=[];return e.nombre_transportadora||t.push("Nombre de transportadora es requerido"),e.nombres_conductor||t.push("Nombre del conductor es requerido"),e.identificacion||t.push("Identificaci\xF3n es requerida"),e.telefono||t.push("Tel\xE9fono es requerido"),e.placa||t.push("Placa es requerida"),e.marca||t.push("Marca es requerida"),e.modelo||t.push("Modelo es requerido"),(e.kilometraje===void 0||e.kilometraje===null)&&t.push("Kilometraje es requerido"),{valid:t.length===0,errors:t}}getStats(){return this.getAllInspections(1,1).pipe(o(e=>({total:e.totalItems,page:e.page,totalPages:e.totalPages})))}static \u0275fac=function(t){return new(t||c)};static \u0275prov=u({token:c,factory:c.\u0275fac,providedIn:"root"})};export{m as a};
